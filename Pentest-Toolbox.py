##Import des bibliothèques et autres programme##
import pyfiglet
import sys
from datetime import datetime
import requests
from MODULES.pdfGeneral import nmap2table, nmap_dictionarisation, vulnnmap, simplify_vulnnmap, simplify_vulnnmap2, \
    markdown2pdf
from MODULES.ScanPort import Nmap_silent, NmapC
from MODULES.sshSimpleBrutForce import sshSimpleBruteForce
from MODULES.sshSimpleBrutForce import ftpsSimpleBruteForce
from MODULES.sshSimpleBrutForce import ftpSimpleBruteForce
from MODULES.searchsploitCli import exploitdbSearch, googledorkgenerator, formatUrl
from MODULES.pdfGeneral import generate_markdown
from MODULES.osint import website_search
from MODULES.osint import dirbuster


##Scanning Menu##
# Definition de la fonction permettant d'afficher le menu de scan
def scan_submenu():
    # Affichage de Scanning Menu en Ascii art
    print(pyfiglet.figlet_format("Scanning Menu", font="slant"))
    # Affichage des options disponible pour l'utilisateur dans le menu
    print("1-NMAP classic")
    print("2-NMAP silent")
    print("3-Back to main menu")
    print("q-Quit")
    # Demande à l'utilisateur son choix
    choice = input("Choose an option : ")
    # en fonction du choix de l'utilisateur affiche le type de scan
    if choice == "1":
        # Demande à l'utilisateur l'ip qu'il faut scanner
        target = str(input("Set target IP\n> "))
        resultat = NmapC(target)
        varvulnmap = vulnnmap(resultat)
        nmapWithVuln = simplify_vulnnmap2(varvulnmap)
        ip = ''
        listservice = []
        for key, value in nmapWithVuln.items():
            if ip != key.split(':')[0]:
                ip = key.split(':')[0]
                hostname = (' '.join(key.split(':')[1:])).split(' - ')
                print('-' * 20)
                if len(hostname) > 1:
                    print(key.split(':')[0] + ' ' + ''.join(hostname[-1]))
                else:
                    print(key.split(':')[0])
                print('-' * 20)
                print('Port\tService\t\t\tVersion\t\tExploit')
            service = (''.join(' '.join(key.split(':')[1:]).split(' - ')[0::-2])).replace(' ', '\t\t', 1).replace(' ',
                                                                                                                  '\t',
                                                                                                                  -1)
            if not value:
                exploit = 0
            else:
                exploit = len(value)
            print('{service}\t\t{exploit}'.format(service=service, exploit=exploit))
            listservice.append(service)

        if nmapWithVuln.keys():
            print('--------------------')
            passworddict = []

        for key in nmapWithVuln.keys():
            service = (''.join(' '.join(key.split(':')[1:]).split(' - ')[0::-2])).replace(' ', '\t\t', 1).replace(' ',
                                                                                                                  '\t',
                                                                                                                  -1)
            servicePort = (key.split(':')[1]).split(' ')[0]
            serviceServer = (key.split(':')[0])

            if "SSH" in (service).upper():
                print(f'SSH Server detect on port {servicePort} on {serviceServer}')
                confirm = input('Do you want test default Password ? (y/n) ')
                if confirm == 'y' or confirm == 'yes':
                    password = sshSimpleBruteForce(serviceServer, servicePort)
                    if password:
                        passworddict.append((key, password))

            elif "FTP" in (service).upper():
                print(f'FTP Server detect on port {servicePort} on {serviceServer}')
                confirm = input('Do you want test default Password ? (y/n)')
                if confirm == 'y' or confirm == 'yes':
                    ftpSimpleBruteForce(serviceServer, servicePort)
                    if password:
                        passworddict.append((key, password))
                    else:
                        passworddict.append((key, False))

        export_submenu(resultat, nmapWithVuln, passworddict)
    elif choice == "2":
        target = str(input("Set target IP\n> "))
        resultat = Nmap_silent(target)
        scan_submenu()
    elif choice == "3":
        main_menu()
    elif choice == "q":
        exit_toolbox()


    else:
        print("Invalid option, please try again.")
        scan_submenu()


##Export Section##
def export_submenu(nmap, nmapWithVuln, passworddict=''):
    print('0 - Return to Scan Menu')
    print('1 - Export to pdf')
    print('2 - Show vuln')
    print('q - Quit')
    choice = input("Choose an option : ")
    if choice == "0":
        scan_submenu()
    elif choice == "1":
        now = datetime.now()
        date_time_str = now.strftime("%d%m%Y%H%M")
        exit = input("Put the path where you want to save the file (ex:/home/) : ")
        exit += "Exploit " + date_time_str + ".pdf"
        markdown2pdf(generate_markdown(nmap, passworddict), exit)
        scan_submenu()
    elif choice == "2":
        dropkeylist = []
        for key, value in nmapWithVuln.items():
            if not len(value):
                dropkeylist += [key]
        for dropkey in dropkeylist:
            del nmapWithVuln[dropkey]
        if len(nmapWithVuln):
            for (i, item) in enumerate(nmapWithVuln.keys(), start=0):
                print('{i}) {item}'.format(i=i, item=item))
            choice = input('choose the service whose vulnerabilities you want to see : ')
            keychoise = list(nmapWithVuln.keys())[int(choice)]
            print("\n".join(["".join(i) for i in nmapWithVuln[keychoise]]))

        else:
            print('no vuln as been detected')
        input('press enter to return to export menu : ')
        export_submenu(nmap, nmapWithVuln)

    elif choice == "q":
        exit_toolbox()


##Exploit Menu##
def exploit_submenu():
    print(pyfiglet.figlet_format("Exploit Menu", font="slant"))
    print("1-Vuln discover")
    print("2-Brut Force")
    print("3-OSINT")
    print("4-Mittre Att&ck")
    print("5-GDorks Generator")
    print("6-Dirbuster")
    print("7-Back to main menu")
    print("q-Quit")
    choice = input("Choose an option : ")
    if choice == "1":
        targetService = input('Enter the service and version for which you want to find vulnerabilities : ')
        for vuln in exploitdbSearch(targetService):
            print("{nom} - {type} \t\t\t - Path to exploit : {file}".format(nom=vuln['titre'], type=vuln['type'],
                                                                            file=vuln['fichier']))
        input('Press Enter for return to submenu')
        exploit_submenu()
    elif choice == "2":
        brutforce_submenu()
    elif choice == "3":
        osint_submenu()
    elif choice == "4":
        print(pyfiglet.figlet_format('Mittre Att&ck'))
        search_term = input("Enter a search term: ")
        searchMittre(search_term)
        main_menu()
    elif choice == "5":
        googleExemple = googledorkgenerator()
        choicegd = 0

        choicepr = input('do you want use preset ? (y/n)')
        if choicepr == 'y':
            googleExemple.presetDork()

        while choicegd != '7':
            print(f'1) Definir In Title : {googleExemple.inTitle}')
            print(f'2) Definir In URL : {googleExemple.inUrl}')
            print(f'3) Definir Domain : {googleExemple.domain}')
            print(f'4) Definir FileType : {googleExemple.fileType}')
            print(f'5) Definir Text : {googleExemple.textQuarry}')
            print(f'6) Generate Gdorcs')
            print(f'7) Quit')

            choicegd = input('Chose an option : ')

            if choicegd == '1':
                value = input('Entrer Valeur : ')
                googleExemple.setTitle(value)
            elif choicegd == '2':
                value = input('Entrer Valeur : ')
                googleExemple.setUrl(value)
            elif choicegd == '3':
                value = input('Entrer Valeur : ')
                googleExemple.setDomain(value)
            elif choicegd == '4':
                value = input('Entrer Valeur : ')
                googleExemple.setFileType(value)
            elif choicegd == '5':
                value = input('Entrer Valeur : ')
                googleExemple.setText(value)
            elif choicegd == '6':
                gdork = googleExemple.generate()
                print('Your GDorks is Ready :')
                print(f'Url Format : {formatUrl(gdork)}')
                print(f'Raw Format : {gdork}')
                print('Click or copy this Gdork in your brother !')
                choicegd = '7'

        input('press enter to return to exploit menu : ')
        exploit_submenu()
    elif choice == "7":
        main_menu()

    elif choice == "q":
        exit_toolbox()

    elif choice == "6":
        print(pyfiglet.figlet_format('Dirbuster'))
        url = input("Please set a website as https://www.supdevinci.fr/ : ")
        dirbuster(url)
    else:
        print("Invalid option, please try again.")
        exploit_submenu()


##Bruteforce section##
def brutforce_submenu():
    print(pyfiglet.figlet_format("Brut Force Menu", font="slant"))
    print("1-SSH")
    print("2-FTP")
    print("3-FTPS")
    print("4-Back to main menu")
    print("q-Quit")
    choice = input("Choose an option : ")
    if choice == "1":
        targetIP = str(input("Set target IP\n> "))
        sshSimpleBruteForce(targetIP, 22)
        brutforce_submenu()
    elif choice == "2":
        targetIP = str(input("Set target IP\n> "))
        ftpSimpleBruteForce(targetIP, 21)
        brutforce_submenu()
    elif choice == "3":
        targetIP = str(input("Set target IP\n> "))
        ftpsSimpleBruteForce(targetIP, 21)
        brutforce_submenu()
    elif choice == "4":
        main_menu()
    elif choice == "q":
        exit_toolbox()
    else:
        print("Invalid option, please try again.")
        brutforce_submenu()


def osint_submenu():
    domain_name = input("Enter a website company name (ex:supdevinci.fr) : ")
    res = website_search(domain_name)
    print(res)
    input("Press Enter to continue...")
    main_menu()


def exit_toolbox():
    print("Thank you for using our ToolBox")
    sys.exit()


##Main execution##
def main_menu():
    print("⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⡠⢤⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n"
          "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡴⠟⠃⠀⠀⠙⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀\n"
          "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⠋⠀⠀⠀⠀⠀⠀⠘⣆⠀⠀⠀⠀⠀⠀⠀⠀\n"
          "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⠾⢛⠒⠀⠀⠀⠀⠀⠀⠀⢸⡆⠀⠀⠀⠀⠀⠀⠀\n"
          "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⣶⣄⡈⠓⢄⠠⡀⠀⠀⠀⣄⣷⠀⠀⠀⠀⠀⠀⠀\n"
          "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣿⣷⠀⠈⠱⡄⠑⣌⠆⠀⠀⡜⢻⠀⠀⠀⠀⠀⠀⠀\n"
          "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⡿⠳⡆⠐⢿⣆⠈⢿⠀⠀⡇⠘⡆⠀⠀⠀⠀⠀⠀\n"
          "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢿⣿⣷⡇⠀⠀⠈⢆⠈⠆⢸⠀⠀⢣⠀⠀⠀⠀⠀⠀\n"
          "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣿⣿⣿⣧⠀⠀⠈⢂⠀⡇⠀⠀⢨⠓⣄⠀⠀⠀⠀\n"
          "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⣿⣿⣿⣦⣤⠖⡏⡸⠀⣀⡴⠋⠀⠈⠢⡀⠀⠀\n"
          "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣾⠁⣹⣿⣿⣿⣷⣾⠽⠖⠊⢹⣀⠄⠀⠀⠀⠈⢣⡀\n"
          "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡟⣇⣰⢫⢻⢉⠉⠀⣿⡆⠀⠀⡸⡏⠀⠀⠀⠀⠀⠀⢇\n"
          "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢨⡇⡇⠈⢸⢸⢸⠀⠀⡇⡇⠀⠀⠁⠻⡄⡠⠂⠀⠀⠀⠘\n"
          "⢤⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⠛⠓⡇⠀⠸⡆⢸⠀⢠⣿⠀⠀⠀⠀⣰⣿⣵⡆⠀⠀⠀⠀\n"
          "⠈⢻⣷⣦⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⡿⣦⣀⡇⠀⢧⡇⠀⠀⢺⡟⠀⠀⠀⢰⠉⣰⠟⠊⣠⠂⠀⡸\n"
          "⠀⠀⢻⣿⣿⣷⣦⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⢧⡙⠺⠿⡇⠀⠘⠇⠀⠀⢸⣧⠀⠀⢠⠃⣾⣌⠉⠩⠭⠍⣉⡇\n"
          "⠀⠀⠀⠻⣿⣿⣿⣿⣿⣦⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣞⣋⠀⠈⠀⡳⣧⠀⠀⠀⠀⠀⢸⡏⠀⠀⡞⢰⠉⠉⠉⠉⠉⠓⢻⠃\n"
          "⠀⠀⠀⠀⠹⣿⣿⣿⣿⣿⣿⣷⡄⠀⠀⢀⣀⠠⠤⣤⣤⠤⠞⠓⢠⠈⡆⠀⢣⣸⣾⠆⠀⠀⠀⠀⠀⢀⣀⡼⠁⡿⠈⣉⣉⣒⡒⠢⡼⠀\n"
          "⠀⠀⠀⠀⠀⠘⣿⣿⣿⣿⣿⣿⣿⣎⣽⣶⣤⡶⢋⣤⠃⣠⡦⢀⡼⢦⣾⡤⠚⣟⣁⣀⣀⣀⣀⠀⣀⣈⣀⣠⣾⣅⠀⠑⠂⠤⠌⣩⡇⠀\n"
          "⠀⠀⠀⠀⠀⠀⠘⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡁⣺⢁⣞⣉⡴⠟⡀⠀⠀⠀⠁⠸⡅⠀⠈⢷⠈⠏⠙⠀⢹⡛⠀⢉⠀⠀⠀⣀⣀⣼⡇⠀\n"
          "⠀⠀⠀⠀⠀⠀⠀⠀⠈⠻⣿⣿⣿⣿⣿⣿⣿⣿⣽⣿⡟⢡⠖⣡⡴⠂⣀⣀⣀⣰⣁⣀⣀⣸⠀⠀⠀⠀⠈⠁⠀⠀⠈⠀⣠⠜⠋⣠⠁⠀\n"
          "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⢿⣿⣿⣿⡟⢿⣿⣿⣷⡟⢋⣥⣖⣉⠀⠈⢁⡀⠤⠚⠿⣷⡦⢀⣠⣀⠢⣄⣀⡠⠔⠋⠁⠀⣼⠃⠀⠀\n"
          "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠻⣿⣿⡄⠈⠻⣿⣿⢿⣛⣩⠤⠒⠉⠁⠀⠀⠀⠀⠀⠉⠒⢤⡀⠉⠁⠀⠀⠀⠀⠀⢀⡿⠀⠀⠀\n"
          "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠙⢿⣤⣤⠴⠟⠋⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠑⠤⠀⠀⠀⠀⠀⢩⠇⠀⠀⠀\n"
          "⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n")
    print("(c) Copyright 2023, Jeannot & Mascarilla")
    print(pyfiglet.figlet_format("Pentest ToolBox", font="slant"))
    print("1-Scanning")
    print("2-Exploit")
    print("q-Quit")
    print("4-Sanity assistant 🌞")
    choice = input("Choose an option : ")
    if choice == "1":
        scan_submenu()
    elif choice == "2":
        exploit_submenu()
    elif choice == "q":
        exit_toolbox()
    elif choice == "4":

        r = requests.get('https://wttr.in/')
        print((r.text).replace('Follow [46m[30m@igor_chubin[0m for wttr.in updates', ''))
        print('For you\'r care touch' + '\033[92m' + '\033[1m' + ' green' + '\033[0m')
        input('Press enter :')
        main_menu()
    else:
        print("Invalid option, please try again.")
        main_menu()


main_menu()
